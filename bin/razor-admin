#! /usr/bin/env jruby

# In case we're calling this from a symlink, we need to ensure all relative
# paths are evaluated from the symlink source, thus we need to use the realpath,
# which will evaluate to the absolute path of the source file
APP_ROOT = File.realpath(__FILE__)

# In case this file is executed from a directory that has its own
# Gemfile, change directories to the razor-server directory first.
Dir.chdir File.expand_path('../..', APP_ROOT)

# Ensure Razor libs are on the Ruby load path
$:.unshift File.join(File.dirname(APP_ROOT), "../lib")

require 'optparse'
require 'bundler/setup'

MIGRATION_DIR=File::expand_path(File::join(File::dirname(APP_ROOT), "../db/migrate"))
show_help=false
target_revision = nil
optparse = OptionParser.new do |opts|
  opts.banner = <<EOS
Usage: razor-admin [options] command

Perform an administrative task on the Razor server.

Options:
EOS
  opts.on "-e", "--environment ENV", "which environment to affect" do |env|
    ENV['RACK_ENV'] = env
  end
  opts.on "-h", "--help", "print this help message" do
    show_help = true
  end
  opts.on "-r", "--revision NUM", "migrate to this revision" do |rev|
    unless rev =~ /^[0-9]+$/
      puts 'revision must be a number'
      exit 1
    end
    target_revision = Integer(rev)
  end
end

COMMANDS = {
  "check-migrations" => -> do
    Sequel::Migrator.is_current?(Razor.database, MIGRATION_DIR)
  end,
  "migrate-database" => Proc.new do
    Sequel::Migrator.apply(Razor.database, MIGRATION_DIR, target_revision)
    true
  end,
  "reset-database" => Proc.new do
    Razor.database.tables.each do |table|
      Razor.database.run("DROP TABLE #{table} CASCADE")
    end
    # @todo lutter 2014-01-21: figure out a more sustainable way to clean
    # out the database
    Razor.database.run("DROP TYPE IF EXISTS power_state")
    Razor.database.run("DROP TYPE IF EXISTS command_status")
    Razor.database.run("DROP TYPE IF EXISTS hook_events")
    Sequel::Migrator.apply(Razor.database, MIGRATION_DIR)
    true
  end
}

rest = optparse.parse(ARGV)
ENV['RACK_ENV'] ||= "development"

if show_help or rest.size != 1 or COMMANDS[rest[0]].nil?
  puts optparse
  puts <<EOS

Available commands:

    check-migrations  check if the database already has the latest schema version.
                      Exits 0 if up to date, 1 otherwise.

    migrate-database  migrate the database to the latest schema version.
                      Use this also for initial schema installation.

    reset-database    delete all data in the database, then install schema
                      the same way that migrate-database does
EOS
  exit 1
end

# It is very important that razor/initialize isn't loaded until after
# RACK_ENV has been set
require 'razor/initialize'
require 'sequel/extensions/migration'

exit COMMANDS[rest[0]].call
